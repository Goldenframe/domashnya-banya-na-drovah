import{r as u,u as F,a as h,l as I,j as s,L as X}from"./index-Yc38Jpbt.js";import{a as K}from"./index-t--hEgTQ.js";import{F as T,f as _,a as q}from"./index-B_uCmsTn.js";import{u as M}from"./auth-DxSWj78Z.js";function G(){const[p,w]=u.useState(""),[i,P]=u.useState(""),[o,x]=u.useState(!1),[l,c]=u.useState({phone:!1,password:!1}),{message:b,showMessage:D,error:m,showError:d,isVisible:C}=M(),f=F(),A=e=>{const a=e.replace(/\D/g,"").slice(0,11);let n=a;return a.length>0&&(n="+7 (",a.length>1&&(n+=`${a.slice(1,4)}`),a.length>4&&(n+=`) ${a.slice(4,7)}`),a.length>7&&(n+=`-${a.slice(7,9)}`),a.length>9&&(n+=`-${a.slice(9)}`)),n},L=e=>{const r=e.target.value,a=p;if(r.length<a.length){w(r);return}const n=A(r);w(n)},N=()=>{const e=p.replace(/\D/g,"");return e.length===10?"7"+e:e},j=async()=>{var r,a,n,y,S,E,$;d(""),c({phone:!1,password:!1});const e=N();if(!e||e.length<11||!i){d("Пожалуйста, введите корректный номер телефона и пароль."),c({phone:!e||e.length<11,password:!i});return}try{const t=await K.post("https://api.dom-ban-na-drovah.ru/api/login",{phone_number:e,password:i},{withCredentials:!0});if(t.status===200){h.set("token",t.data.token,{expires:7,secure:!0,sameSite:"Strict"}),h.set("userId",t.data.userId,{expires:7,secure:!0,sameSite:"Strict"}),h.set("firstName",t.data.first_name,{expires:7,secure:!0,sameSite:"Strict"}),h.set("lastName",t.data.last_name,{expires:7,secure:!0,sameSite:"Strict"}),D("Вход выполнен успешно!");const v=I(t.data.token);if(!v){console.error("Ошибка: токен не может быть декодирован");return}f(v.role==="admin"?`/adminAccount/${t.data.userId}`:`/userAccount/${t.data.userId}`)}}catch(t){((r=t.response)==null?void 0:r.status)===401?((n=(a=t.response)==null?void 0:a.data)!=null&&n.message.includes("Пользователя с таким номером телефона не существует!")?(d("Пользователя с таким номером телефона не существует!"),c({phone:!0,password:!1})):(S=(y=t.response)==null?void 0:y.data)!=null&&S.message.includes("Неверный пароль")&&(d("Неверный пароль! Попробуйте снова."),c({phone:!1,password:!0})),setTimeout(()=>c({phone:!1,password:!1}),8e3)):d((($=(E=t.response)==null?void 0:E.data)==null?void 0:$.message)||"Ошибка входа.")}};u.useEffect(()=>{const e=h.get("token");if(e){const r=I(e);r.exp*1e3>Date.now()&&f(r.role==="admin"?`/adminAccount/${r.userId}`:`/userAccount/${r.userId}`)}},[f]);const g=!(N().length>=11)||!i,k=e=>{e.key==="Enter"&&!g&&j()};return s.jsx("main",{className:"auth-container",children:s.jsx("div",{className:"auth-block log",children:s.jsxs("div",{className:"auth-content",children:[s.jsx("h1",{className:"auth-title",children:"ВХОД"}),(b||m)&&s.jsx("p",{className:`auth-message ${m?"error":"success"} ${C?"fade-in":"fade-out"}`,role:"alert",children:b||m}),s.jsxs("div",{className:"auth-form",children:[s.jsxs("label",{className:`auth-label ${l.phone?"error-label":""}`,htmlFor:"phone",children:["Номер телефона",s.jsx("input",{type:"tel",id:"phone",className:`auth-input ${l.phone?"error-input":""}`,placeholder:"+7 (XXX) XXX-XX-XX",onChange:L,value:p,"aria-describedby":"phoneError",required:!0,maxLength:18,onKeyDown:k}),l.phone&&s.jsx("span",{id:"phoneError",className:"error-message",children:"Неверный номер телефона"})]}),s.jsxs("label",{className:`auth-label ${l.password?"error-label":""}`,htmlFor:"password",children:["Пароль",s.jsxs("div",{className:"passwordInput",children:[s.jsx("input",{type:o?"text":"password",id:"password",className:`auth-input ${l.password?"error-input":""}`,placeholder:"Введите пароль",onChange:e=>P(e.target.value),value:i,maxLength:16,"aria-describedby":"passwordError",required:!0,onKeyDown:k}),s.jsx(T,{icon:o?_:q,className:"passwordIcon",onClick:()=>x(!o),"aria-label":o?"Скрыть пароль":"Показать пароль",tabIndex:"0",onKeyDown:e=>{(e.key==="Enter"||e.key===" ")&&x(!o)},role:"button","aria-pressed":o})]}),l.password&&s.jsx("span",{id:"passwordError",className:"error-message",children:"Неверный пароль"})]}),s.jsx("button",{className:"auth-button",onClick:j,disabled:g,"aria-disabled":g,children:"Войти"})]}),s.jsxs("div",{className:"auth-links",children:[s.jsxs("p",{children:["Еще нет учетной записи?"," ",s.jsx(X,{to:"/register",className:"auth-link",children:"Зарегистрируйтесь"})]}),s.jsx(X,{to:"/forgot-password",className:"auth-link",children:"Забыли пароль?"})]})]})})})}export{G as default};
