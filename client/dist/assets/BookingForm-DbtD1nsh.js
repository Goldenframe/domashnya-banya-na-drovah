import{r as b,j as e,a as ae}from"./index-Yc38Jpbt.js";import{a as G}from"./index-t--hEgTQ.js";import{F as ie,d as ue,e as de}from"./index-B_uCmsTn.js";import{S as le}from"./react-select.esm-DNlj9HSV.js";import{u as me}from"./auth-DxSWj78Z.js";function he({availableDates:l,bookingDate:L,setBookingDate:n}){const[C,p]=b.useState(new Date),T=l.map(i=>new Date(i)).sort((i,u)=>i-u),y=i=>{const u=i.getFullYear(),N=String(i.getMonth()+1).padStart(2,"0"),q=String(i.getDate()).padStart(2,"0");return`${u}-${N}-${q}`},D=C.getFullYear(),m=C.getMonth(),x=[],A=new Date(D,m,1),$=Array.from({length:new Date(D,m+1,0).getDate()},(i,u)=>new Date(D,m,u+1)),F=$.filter(i=>!T.some(u=>y(u)===y(i))),k=(A.getDay()+6)%7;for(let i=0;i<k;i++)x.push(e.jsx("div",{"aria-hidden":"true",role:"presentation",tabIndex:"-1"},`empty-${i}`));$.forEach(i=>{const u=y(i),N=F.some(I=>y(I)===u);let q="calendar_day";N&&(q+=" no-interval"),L.includes(u)&&(q+=" selected"),x.push(e.jsx("div",{className:q,onClick:N?void 0:()=>n(I=>I===u?"":u),role:"gridcell","aria-label":`${i.toLocaleString("ru-RU",{weekday:"long"})}, ${i.getDate()} ${i.toLocaleString("ru-RU",{month:"long"})} ${i.getFullYear()}`,tabIndex:N?"-1":"0",children:i.getDate()},`day-${u}`))});const M=(7-new Date(D,m+1,0).getDay())%7;for(let i=0;i<M;i++)x.push(e.jsx("div",{"aria-hidden":"true",role:"presentation",tabIndex:"-1"},`empty-after-${i}`));const z=["Январь","Февраль","Март","Апрель","Май","Июнь","Июль","Август","Сентябрь","Октябрь","Ноябрь","Декабрь"];return e.jsx("div",{role:"application",children:e.jsxs("div",{className:"calendar_container",children:[e.jsxs("div",{className:"calendar_header",children:[e.jsx("button",{onClick:()=>p(new Date(D,m-1,1)),type:"button",className:"arrow-button","aria-label":"Предыдущий месяц",children:e.jsx(ie,{icon:ue})}),e.jsx("span",{children:`${z[m]} ${D}`}),e.jsx("button",{onClick:()=>p(new Date(D,m+1,1)),type:"button",className:"arrow-button","aria-label":"Следующий месяц",children:e.jsx(ie,{icon:de})})]}),e.jsxs("div",{className:"calendar",role:"grid",children:[["Пн","Вт","Ср","Чт","Пт","Сб","Вс"].map((i,u)=>e.jsx("div",{style:{textAlign:"center",fontWeight:"bold"},role:"columnheader",children:i},u)),x]})]})})}function pe({additionalServices:l,setAdditionalServices:L,discounts:n,start:C,end:p,bookingDate:T,additionalServicesQuantity:y,setAdditionalServicesQuantity:D}){var Q,M,z,i,u,N,q,I,U,J,V,H,O,R,K,P;const m={broom:150,towel:200,hat:50,sheets:200},x={broom:4,towel:8,hat:8,sheets:2},A=()=>{const r={...y};n.forEach(d=>{if(d.discount_type!=="free"||!F(d))return;(d.applicable_services.length>0?d.applicable_services:Object.keys(d.free_service_counts)).forEach(v=>{var X,Y;const g=((X=l[v])==null?void 0:X.quantity)||0,B=parseInt(((Y=d.min_service_counts)==null?void 0:Y[v])||"0",10);if(g>=B){const Z=Math.floor(g/B)*d.free_service_counts[v];r[v]=(r[v]||0)+Z}})}),console.log("Обновленные бесплатные услуги:",r),D(r)};b.useEffect(()=>{A()},[T,l]);const $=(r,d)=>{d=Math.max(0,Math.min(d,x[r])),L(v=>{const g={...v,[r]:{selected:d>0,quantity:d}};return console.log("Обновленные услуги:",g),g});const w=S();D(v=>{const g={...v,[r]:w};return console.log("Обновленные бесплатные услуги:",g),g})},F=r=>{if(!C||!p||!T)return!1;const d=new Date(`${T}T${C}`),w=new Date(`${T}T${p}`),v=new Date(`${T}T${r.valid_from}`),g=new Date(`${T}T${r.valid_till}`),B=r.time_discount_type==="time_limit"?d>=v&&w<=g&&r.applicable_days.includes(T):d>=v&&w<=g;return console.log("Проверяем скидку:",r,"Применима:",B),B},S=(r,d,w)=>0,k=r=>{var w;const d=n==null?void 0:n.find(v=>{var g;return((g=v.applicable_services)==null?void 0:g.includes(r))&&v.discount_type==="discount_service"&&F(v)});return((w=d==null?void 0:d.service_prices)==null?void 0:w[r])??m[r]},_=(r,d)=>{var v;const w=((v=l[r])==null?void 0:v.quantity)||0;$(r,w+d)};return e.jsxs("section",{className:"additional-services","aria-labelledby":"additional-services-heading",children:[e.jsxs("div",{className:"service-item",children:[e.jsx("div",{className:"service-info",children:e.jsxs("label",{htmlFor:"broom-quantity",children:["Дубовые веники (+",k("broom")," ₽)",y.broom>0&&e.jsxs("span",{className:"free-gift",children:[" ","(+",y.broom," в подарок)"]})]})}),e.jsxs("div",{className:"service-quantity",children:[e.jsx("button",{onClick:()=>_("broom",-1),type:"button","aria-label":"Уменьшить количество дубовых веников",disabled:((Q=l.broom)==null?void 0:Q.quantity)===0,children:"-"}),e.jsx("input",{id:"broom-quantity",type:"number",min:"0",max:x.broom,value:((M=l.broom)==null?void 0:M.quantity)||0,onChange:r=>$("broom",parseInt(r.target.value)),className:"service-quantity-input","aria-label":"Количество дубовых веников"}),e.jsx("button",{onClick:()=>_("broom",1),type:"button","aria-label":"Увеличить количество дубовых веников",disabled:((z=l.broom)==null?void 0:z.quantity)===x.broom,children:"+"})]})]}),e.jsxs("div",{className:"service-item",children:[e.jsx("div",{className:"service-info",children:e.jsxs("label",{htmlFor:"towel-quantity",children:["Полотенце (+",k("towel")," ₽)"]})}),e.jsxs("div",{className:"service-quantity",children:[e.jsx("button",{onClick:()=>_("towel",-1),type:"button","aria-label":"Уменьшить количество полотенец",disabled:((i=l.towel)==null?void 0:i.quantity)===0,children:"-"}),e.jsx("input",{id:"towel-quantity",type:"number",min:"0",max:x.towel,value:((u=l.towel)==null?void 0:u.quantity)||0,onChange:r=>$("towel",parseInt(r.target.value)),className:"service-quantity-input","aria-label":"Количество полотенец"}),e.jsx("button",{onClick:()=>_("towel",1),type:"button","aria-label":"Увеличить количество полотенец",disabled:((N=l.towel)==null?void 0:N.quantity)===x.towel,children:"+"})]})]}),e.jsxs("div",{className:"service-item",children:[e.jsx("div",{className:"service-info",children:e.jsxs("label",{htmlFor:"hat-quantity",children:["Шапка (+",k("hat")," ₽)",S("hat",((q=l.hat)==null?void 0:q.quantity)||0)>0&&e.jsxs("span",{className:"free-gift",children:[" ","(+",S("hat",((I=l.hat)==null?void 0:I.quantity)||0)," ","в подарок)"]})]})}),e.jsxs("div",{className:"service-quantity",children:[e.jsx("button",{onClick:()=>_("hat",-1),type:"button","aria-label":"Уменьшить количество шапок",disabled:((U=l.hat)==null?void 0:U.quantity)===0,children:"-"}),e.jsx("input",{id:"hat-quantity",type:"number",min:"0",max:x.hat,value:((J=l.hat)==null?void 0:J.quantity)||0,onChange:r=>$("hat",parseInt(r.target.value)),className:"service-quantity-input","aria-label":"Количество шапок"}),e.jsx("button",{onClick:()=>_("hat",1),type:"button","aria-label":"Увеличить количество шапок",disabled:((V=l.hat)==null?void 0:V.quantity)===x.hat,children:"+"})]})]}),e.jsxs("div",{className:"service-item",children:[e.jsx("div",{className:"service-info",children:e.jsxs("label",{htmlFor:"sheets-quantity",children:["Простынь (+",k("sheets")," ₽)",S("sheets",((H=l.sheets)==null?void 0:H.quantity)||0)>0&&e.jsxs("span",{className:"free-gift",children:[" ","(+",S("sheets",((O=l.sheets)==null?void 0:O.quantity)||0)," ","в подарок)"]})]})}),e.jsxs("div",{className:"service-quantity",children:[e.jsx("button",{onClick:()=>_("sheets",-1),type:"button","aria-label":"Уменьшить количество простыней",disabled:((R=l.sheets)==null?void 0:R.quantity)===0,children:"-"}),e.jsx("input",{id:"sheets-quantity",type:"number",min:"0",max:x.sheets,value:((K=l.sheets)==null?void 0:K.quantity)||0,onChange:r=>$("sheets",parseInt(r.target.value)),className:"service-quantity-input","aria-label":"Количество простыней"}),e.jsx("button",{onClick:()=>_("sheets",1),type:"button","aria-label":"Увеличить количество простыней",disabled:((P=l.sheets)==null?void 0:P.quantity)===x.sheets,children:"+"})]})]})]})}function xe({userId:l,token:L}){const[n,C]=b.useState(""),[p,T]=b.useState(""),[y,D]=b.useState(""),[m,x]=b.useState({broom:{selected:!1,quantity:0},towel:{selected:!1,quantity:0},hat:{selected:!1,quantity:0},sheets:{selected:!1,quantity:0}}),[A,$]=b.useState({broom:0,towel:0,hat:0,sheets:0}),[F,S]=b.useState(0),[k,_]=b.useState([]),[Q,M]=b.useState([]),[z,i]=b.useState([]),[u,N]=b.useState([]),[q,I]=b.useState(""),[U,J]=b.useState(""),{message:V,showMessage:H,error:O,showError:R,isVisible:K}=me(),P=new Date;new Date(P).setDate(P.getDate()+21);const d=b.useCallback(async()=>{try{const t=ae.get("token");let s=(await G.get(`https://api.dom-ban-na-drovah.ru/api/userAccount/${l}/availableIntervals/${n}`,{headers:{Authorization:`Bearer ${t}`}})).data.availableStartTimes;_(s),H("")}catch(t){console.error("Ошибка при получении интервалов:",t),R("Произошла ошибка при получении доступных интервалов.")}},[l,n]),w=b.useCallback(async(t,a)=>{try{const s=ae.get("token"),o=await G.get(`https://api.dom-ban-na-drovah.ru/api/userAccount/${l}/availableEndTimes/${n}/${t}/${a}`,{headers:{Authorization:`Bearer ${s}`}});if(o.data.availableEndTimes.length===0)_(f=>f.filter(h=>h.startTime!==t)),H("Нет доступных конечных времен для выбранного времени начала."),M([]);else{const f=o.data.availableEndTimes.map(h=>h.endTime);f.includes("24:00")||f.push("24:00"),M(f),H("")}}catch(s){console.error("Ошибка при получении конечных времен:",s),R("Произошла ошибка при получении доступных конечных времен.")}},[l,n]);b.useEffect(()=>{n&&d()},[n,d]),b.useEffect(()=>{let t=u.filter(a=>a.time_discount_type==="time_limit"&&a.applicable_days.includes(n));I(t.length>0?t:[])},[n,u]),b.useEffect(()=>{let t=u.filter(a=>a.time_discount_type==="no_time_limit");J(t.length>0?t:[])},[n,u]);const v=t=>{const a=t.value;T(a);const s=k.find(o=>o.startTime===a);s?(w(a,s.intervalId),y&&g(a,y)):M([])},g=async(t,a)=>{const s=t?new Date(`${n}T${t}`):null,o=a?new Date(`${n}T${a}`):null,f=s&&o?await X(s,o):0,h=re(s,o);S(f+h)};b.useEffect(()=>{g(p,y)},[m,n]);const B=async()=>{try{const t=await G.get(`https://api.dom-ban-na-drovah.ru/api/userAccount/${l}/discounts`,{headers:{Authorization:`Bearer ${L}`}});N(t.data)}catch(t){return console.error("Ошибка при получении скидок:",t),[]}};b.useEffect(()=>{B()},[l]),b.useEffect(()=>{T(""),D("")},[n]);const X=async(t,a)=>{console.log("--- CALCULATION START ---"),console.log("Original start:",t),console.log("Original end:",a);const s=new Date(t),o=new Date(a);if(o.getHours()===0&&o.getMinutes()===0&&(o.setFullYear(s.getFullYear(),s.getMonth(),s.getDate()),o.setHours(24,0,0,0)),console.log("Adjusted start:",s),console.log("Adjusted end:",o),o<=s)return console.log("Invalid time interval"),0;const h=(o.getTime()-s.getTime())/(1e3*60*60);let c=0;const j=s.getHours(),E=s.getDay();return E===0||E===6?c=h<=2?3800:Math.round(1600*h):j>=8&&j<16?c=h<=2?3500:Math.round(1500*h):(j>=16||j<8)&&(c=h<=2?3800:Math.round(1600*h)),u.forEach(ne=>{if(Y(ne,s,o)){const ce=Z(c,ne);c-=ce}}),Math.max(0,Math.round(c))},Y=(t,a,s)=>{const o=new Date(`${n}T${t.valid_from}`),f=new Date(`${n}T${t.valid_till}`),h=a||new Date(`${n}T08:00`),c=s||new Date(`${n}T23:59`);return t.time_discount_type==="time_limit"?h>=o&&c<=f&&t.applicable_days.includes(n):h>=o&&c<=f},Z=(t,a)=>a.discount_type==="discount"?t*(a.discount_percentage/100):0,re=(t,a)=>{var f,h;let s=0;const o={broom:150,towel:200,hat:50,sheets:200};for(let c in m)if(((f=m[c])==null?void 0:f.quantity)>0){const j=u.find(W=>Array.isArray(W.applicable_services)&&W.applicable_services.includes(c)&&W.discount_type==="discount_service"&&Y(W,t,a));console.log(`Проверяем скидку на ${c}:`,j);const E=((h=j==null?void 0:j.service_prices)==null?void 0:h[c])??o[c];s+=m[c].quantity*E}return s},ee=t=>t?Q.filter(a=>a>t).sort().map(a=>({value:a,label:a})):[],te=k.map(t=>({value:t.startTime,label:t.startTime})),oe=async t=>{t.preventDefault();const a=ae.get("token"),s=p?new Date(`${n}T${p}`):null,o=y?new Date(`${n}T${y}`):null,f=u.filter(c=>Y(c,s,o)?c.discount_type==="discount_service"?c.applicable_services.some(j=>{var E;return((E=m[j])==null?void 0:E.quantity)>0}):!0:!1);console.log("Примененные скидки:",f);const h=f.length>0?f[0].id:null;try{if(!n||!p||!y)throw new Error("Пожалуйста, выберите дату и время.");const c=await G.post(`https://api.dom-ban-na-drovah.ru/api/userAccount/${l}/book`,{booking_date:n,start_time:p,end_time:y,price:F,broom:m.broom.selected,broom_quantity:m.broom.quantity+(A.broom||0),towel:m.towel.selected,towel_quantity:m.towel.quantity+(A.towel||0),hat:m.hat.selected,hat_quantity:m.hat.quantity+(A.hat||0),sheets:m.sheets.selected,sheets_quantity:m.sheets.quantity+(A.sheets||0),discount_id:h},{headers:{Authorization:`Bearer ${a}`}});H("Бронь успешно оформлена!"),(await se(l,[n],a)).includes(n)&&i(E=>E.filter(W=>W!==n)),C(""),T(""),D(""),S(0),x({broom:{selected:!1,quantity:0},towel:{selected:!1,quantity:0},hat:{selected:!1,quantity:0},sheets:{selected:!1,quantity:0}}),$({broom:0,towel:0,hat:0,sheets:0})}catch(c){let j=c.message;c.response?j=c.response.data.error||c.response.data.message||"Произошла непредвиденная ошибка.":c.request&&(j="Ошибка сети. Пожалуйста, проверьте Ваше соединение."),R(j),console.error("Ошибка при бронировании:",c)}},se=async(t,a,s)=>{const o=[];for(const f of a)try{(await G.get(`https://api.dom-ban-na-drovah.ru/api/userAccount/${t}/availableIntervals/${f}`,{headers:{Authorization:`Bearer ${s}`}})).data.availableStartTimes.length===0&&o.push(f)}catch(h){console.error(`Ошибка при проверке доступности для даты ${f}:`,h)}return o};return b.useEffect(()=>{const t=[];for(let a=0;a<62;a++){const s=new Date(P);s.setDate(P.getDate()+a),t.push(s.toISOString().slice(0,10))}se(l,t,L).then(a=>{const s=t.filter(o=>!a.includes(o));i(s),s.length>0&&C(s[0])})},[l,L]),e.jsx("section",{className:"account-content",children:e.jsxs("div",{className:"account-form",children:[(V||O)&&e.jsx("div",{className:`auth-message ${O?"error":"success"} ${K?"fade-in":"fade-out"}`,role:O?"alert":"status","aria-live":"assertive",children:V||O}),e.jsxs("form",{onSubmit:oe,className:"booking-wrapper","aria-labelledby":"bookingFormTitle",children:[e.jsx("div",{className:"calendar-container",children:e.jsx(he,{availableDates:z,setAvailableDates:i,setBookingDate:C,bookingDate:n})}),e.jsxs("div",{className:"time-controls",children:[U.length>0&&e.jsxs("section",{"aria-labelledby":"permanentDiscountsHeading",className:"discounts",children:[e.jsx("h2",{id:"permanentDiscountsHeading",className:"visually-hidden",children:"Постоянные акции"}),e.jsx("div",{className:"discount permanent-discount",role:"region",children:U.map((t,a)=>e.jsxs("p",{children:[e.jsx("strong",{children:"Постоянная акция:"})," ",t.description]},a))})]}),q.length>0&&e.jsxs("section",{"aria-labelledby":"temporaryDiscountsHeading",className:"discounts",children:[e.jsx("h2",{id:"temporaryDiscountsHeading",className:"visually-hidden",children:"Временные акции"}),e.jsx("div",{className:"discount temporary-discount",role:"region",children:q.map((t,a)=>e.jsxs("p",{children:[e.jsx("strong",{children:"Временная акция:"})," ",t.description]},a))})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"startTimeSelect",className:"form-label",children:"Время начала:"}),e.jsx(le,{id:"startTimeSelect",inputId:"startTimeInput",value:p?{value:p,label:p}:null,onChange:v,options:te,classNamePrefix:"time-select",placeholder:"Выберите время",isDisabled:te.length===0,"aria-labelledby":"startTimeLabel","aria-describedby":te.length===0?"noStartTimesHelp":void 0})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"endTimeSelect",className:"form-label",children:"Время окончания:"}),e.jsx(le,{id:"endTimeSelect",inputId:"endTimeInput",value:y?{value:y,label:y}:null,onChange:t=>{D(t.value),g(p,t.value)},options:ee(p),classNamePrefix:"time-select",placeholder:"Выберите время",isDisabled:!p||ee(p).length===0,"aria-labelledby":"endTimeLabel","aria-describedby":p?ee(p).length===0?"noEndTimesHelp":void 0:"selectStartTimeFirstHelp"})]})]}),e.jsx("div",{className:"additional-services-container",children:e.jsx(pe,{additionalServices:m,setAdditionalServices:x,discounts:u,start:p,end:y,bookingDate:n,additionalServicesQuantity:A,setAdditionalServicesQuantity:$})}),e.jsx("div",{className:"price-container",role:"region","aria-live":"polite",children:e.jsxs("div",{className:"price-content",children:[e.jsxs("p",{className:"price",children:[e.jsx("strong",{children:"Итоговая стоимость:"}),e.jsxs("span",{"aria-label":`${F} рублей`,children:[F," ₽"]})]}),e.jsx("button",{type:"submit",className:"form-button",disabled:!n||!p||!y,"aria-disabled":!n||!p||!y,children:"Забронировать"})]})})]})]})})}export{xe as default};
