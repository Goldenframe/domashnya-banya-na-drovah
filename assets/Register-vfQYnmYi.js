import{r as y,u as L,j as s,L as R,a as f}from"./index-Yc38Jpbt.js";import{a as S}from"./index-t--hEgTQ.js";import{f as T,a as V,F as _}from"./index-B_uCmsTn.js";import{u as $}from"./auth-DxSWj78Z.js";const E=(r=!1)=>{const[l,t]=y.useState(r),o=()=>t(!l);return{type:l?"text":"password",icon:l?T:V,toggle:o,handleKeyDown:u=>{(u.key==="Enter"||u.key===" ")&&(u.preventDefault(),o())},visible:l}};function U(){const[r,l]=y.useState({firstName:"",lastName:"",password:"",confirmPassword:"",phoneNumber:"",verificationCode:""}),[t,o]=y.useState({isCodeSent:!1,canResendCode:!0,isSubmitting:!1}),N=E(),u=E(),D=L(),{message:w,showMessage:k,error:g,showError:p,isVisible:F}=$(),P=e=>{const a=e.replace(/\D/g,"").slice(0,11);let i=a;return a.length>0&&(i="+7 (",a.length>1&&(i+=`${a.slice(1,4)}`),a.length>4&&(i+=`) ${a.slice(4,7)}`),a.length>7&&(i+=`-${a.slice(7,9)}`),a.length>9&&(i+=`-${a.slice(9)}`)),i},q=e=>{const n=e.target.value,a=r.phoneNumber;if(n.length<a.length){l(d=>({...d,phoneNumber:n}));return}const i=P(n);l(d=>({...d,phoneNumber:i}))},x=()=>{const e=r.phoneNumber.replace(/\D/g,"");return e.length===10?"7"+e:e},m=e=>{const{id:n,value:a}=e.target;n==="phoneNumber"?q(e):l(i=>({...i,[n]:a}))},c=async()=>{var e,n;o(a=>({...a,isSubmitting:!0}));try{const a=x();(await S.post("https://api.dom-ban-na-drovah.ru/api/register",{phone_number:a},{withCredentials:!0})).status===200&&(o({isCodeSent:!0,canResendCode:!1,isSubmitting:!1}),k("Код отправлен на Ваш номер телефона."),setTimeout(()=>o(d=>({...d,canResendCode:!0})),6e4))}catch(a){o(i=>({...i,isSubmitting:!1})),p(((n=(e=a.response)==null?void 0:e.data)==null?void 0:n.error)||"Ошибка отправки кода.")}},j=async()=>{var e,n;if(r.password!==r.confirmPassword){p("Пароли не совпадают!");return}o(a=>({...a,isSubmitting:!0}));try{const a=x(),i=await S.post("https://api.dom-ban-na-drovah.ru/api/verify-registration",{first_name:r.firstName,last_name:r.lastName,password:r.password,phone_number:a,verification_code:r.verificationCode},{withCredentials:!0});if(i.status===201){const{token:d,userId:C,first_name:X,last_name:I}=i.data;f.set("token",d,{expires:7,secure:!0}),f.set("userId",C,{expires:7,secure:!0}),f.set("firstName",X,{expires:7,secure:!0}),f.set("lastName",I,{expires:7,secure:!0}),D(`/userAccount/${C}`)}else p("Неизвестная ошибка сервера")}catch(a){a.code==="ECONNABORTED"?p("Сервер не отвечает. Попробуйте позже."):p(((n=(e=a.response)==null?void 0:e.data)==null?void 0:n.error)||"Ошибка регистрации. Проверьте данные.")}finally{o(a=>({...a,isSubmitting:!1}))}},h=r.firstName&&r.lastName&&r.password&&r.confirmPassword&&x().length>=11,K=r.verificationCode.length===4,b=(e,n)=>{(e.key==="Enter"||e.key===" ")&&(e.preventDefault(),n())},v=e=>s.jsx(_,{icon:e.icon,className:"passwordIcon",onClick:e.toggle,onKeyDown:e.handleKeyDown,tabIndex:"0",role:"button","aria-label":e.visible?"Скрыть пароль":"Показать пароль","aria-pressed":e.visible});return s.jsx("main",{className:"auth-container",role:"region","aria-labelledby":"registerTitle",children:s.jsx("div",{className:"auth-block reg",role:"group","aria-labelledby":"registerBlockLabel",children:s.jsxs("div",{className:"auth-content",children:[s.jsx("h1",{id:"registerTitle",className:"auth-title",children:"РЕГИСТРАЦИЯ"}),(w||g)&&s.jsx("p",{className:`auth-message ${g?"error":"success"} ${F?"fade-in":"fade-out"}`,role:"alert",children:w||g}),s.jsx("div",{className:"auth-form",children:s.jsxs("div",{className:"auth-row",children:[s.jsxs("div",{className:"auth-column",children:[s.jsxs("label",{className:"auth-label",htmlFor:"firstName",children:["Имя",s.jsx("input",{type:"text",id:"firstName",className:"auth-input",placeholder:"Введите имя",maxLength:20,onChange:e=>m(e),value:r.firstName,required:!0,"aria-required":"true","aria-describedby":"firstNameError"}),s.jsx("span",{id:"firstNameError",className:"screen-reader-only"})]}),s.jsxs("label",{className:"auth-label",htmlFor:"lastName",children:["Фамилия",s.jsx("input",{type:"text",id:"lastName",className:"auth-input",placeholder:"Введите фамилию",maxLength:20,onChange:e=>m(e),value:r.lastName,required:!0,"aria-required":"true","aria-describedby":"lastNameError"}),s.jsx("span",{id:"lastNameError",className:"screen-reader-only"})]})]}),s.jsxs("div",{className:"auth-column",children:[s.jsxs("label",{className:"auth-label",htmlFor:"password",children:["Пароль",s.jsxs("div",{className:"passwordInput",children:[s.jsx("input",{type:N.type,id:"password",className:"auth-input",placeholder:"Введите пароль",maxLength:16,onChange:e=>m(e),value:r.password,required:!0,"aria-required":"true","aria-describedby":"passwordError"}),v(N)]}),s.jsx("span",{id:"passwordError",className:"screen-reader-only"})]}),s.jsxs("label",{className:"auth-label",htmlFor:"confirmPassword",children:["Проверка пароля",s.jsxs("div",{className:"passwordInput",children:[s.jsx("input",{type:u.type,id:"confirmPassword",className:"auth-input",placeholder:"Повторите пароль",maxLength:16,onChange:e=>m(e),value:r.confirmPassword,required:!0,"aria-required":"true","aria-describedby":"confirmPasswordError"}),v(u)]}),s.jsx("span",{id:"confirmPasswordError",className:"screen-reader-only"})]})]}),s.jsxs("div",{className:"auth-column",children:[s.jsxs("label",{className:"auth-label",htmlFor:"phoneNumber",children:["Номер телефона",s.jsx("input",{type:"tel",id:"phoneNumber",className:"auth-input",placeholder:"+7 (XXX) XXX-XX-XX",maxLength:18,onChange:e=>m(e),value:r.phoneNumber,required:!0,"aria-required":"true","aria-describedby":"phoneNumberError"}),s.jsx("span",{id:"phoneNumberError",className:"screen-reader-only"})]}),h&&s.jsxs("label",{className:"auth-label",htmlFor:"verificationCode",children:["Код верификации",s.jsx("input",{type:"text",id:"verificationCode",className:"auth-input",placeholder:"Введите код",maxLength:4,onChange:e=>m(e),onKeyDown:e=>{e.key==="Enter"&&h&&!t.isCodeSent&&(e.preventDefault(),c())},value:r.verificationCode,required:!0,"aria-required":"true","aria-describedby":"verificationCodeError"}),s.jsx("span",{id:"verificationCodeError",className:"screen-reader-only"})]})]})]})}),!t.isCodeSent&&!h&&s.jsx("button",{className:"auth-button",onClick:c,onKeyDown:e=>b(e,c),disabled:!h||t.isSubmitting,"aria-busy":t.isSubmitting,"aria-live":"polite",children:"Зарегистрироваться"}),h&&!t.isCodeSent&&s.jsxs(s.Fragment,{children:[s.jsx("p",{className:"auth-info",children:"На Ваш номер телефона поступит звонок, введите последние 4 цифры номера."}),s.jsx("button",{className:"auth-button",onClick:c,onKeyDown:e=>b(e,c),disabled:!h||t.isSubmitting,"aria-busy":t.isSubmitting,"aria-live":"polite",children:t.isSubmitting?"Отправка...":"Отправить код"})]}),t.isCodeSent&&s.jsxs(s.Fragment,{children:[s.jsx("button",{className:"auth-button",onClick:j,onKeyDown:e=>b(e,j),disabled:!K||t.isSubmitting,"aria-busy":t.isSubmitting,"aria-live":"polite",children:t.isSubmitting?"Регистрация...":"Зарегистрироваться"}),t.canResendCode&&s.jsx("button",{className:"auth-button",onClick:c,onKeyDown:e=>b(e,c),disabled:t.isSubmitting,"aria-busy":t.isSubmitting,"aria-live":"polite",children:"Отправить код еще раз"})]}),s.jsx("div",{className:"auth-links",children:s.jsxs("p",{children:["Уже есть учетная запись?",s.jsx(R,{to:"/login",className:"auth-link",children:"Войдите"})]})})]})})})}export{U as default};
