import{r as t,u as Fe,j as e,a as f}from"./index-CdRdZjSu.js";import{a as j}from"./index-t--hEgTQ.js";import{F as $,f as R,a as U,g as Ae,h as Ee}from"./index-D2BKn4qM.js";import{u as De}from"./auth-DZS8ZimE.js";const Le=({userId:w,token:g,updateUserData:O})=>{const[m,X]=t.useState(""),[p,k]=t.useState(""),[d,C]=t.useState(""),[y,q]=t.useState(!1),[l,G]=t.useState({}),[S,ie]=t.useState(""),[c,H]=t.useState(""),[b,J]=t.useState(""),[F,le]=t.useState(!1),[A,ce]=t.useState(!1),[E,de]=t.useState(!1),[ue,B]=t.useState(!1),[L,P]=t.useState(!1),[T,z]=t.useState(!1),[K,he]=t.useState(""),[s,u]=t.useState({firstName:!1,lastName:!1,phone:!1,currentPassword:!1,newPassword:!1,confirmPassword:!1}),[Ie,Q]=t.useState(!1),[me,W]=t.useState(!1),{message:Y,showMessage:D,error:M,showError:o,isVisible:pe}=De(),Z=Fe();t.useEffect(()=>{(async()=>{try{const r=await j.get(`https://api.dom-ban-na-drovah.ru/api/userAccount/${w}/profileData`,{headers:{Authorization:`Bearer ${g}`}});G(r.data),X(r.data.first_name),k(r.data.last_name),C(ee(r.data.phone_number))}catch(r){o("Ошибка загрузки данных пользователя"),console.error("Ошибка загрузки данных пользователя:",r)}})()},[w,g]);const V=a=>a.replace(/\D/g,"");t.useEffect(()=>{const a=V(d),r=V(l.phone_number||"");P(m!==l.first_name||p!==l.last_name||a!==r||c!==""||b!==""),q(a!==r&&a.trim()!=="")},[m,p,d,c,b,l]);const fe=async()=>{try{const a=f.get("token");if(!a){o("Не найден токен. Пожалуйста, войдите снова.");return}const r=await j.delete(`https://api.dom-ban-na-drovah.ru/api/userAccount/${w}`,{headers:{Authorization:`Bearer ${a}`}});D(r.data.message),f.remove("token"),f.remove("userId"),f.remove("firstName"),f.remove("lastName"),Z("/login")}catch(a){o("Ошибка при удалении аккаунта"),console.error("Ошибка при удалении аккаунта:",a)}},we=()=>{B(!1)},Ne=()=>{f.remove("token"),f.remove("userId"),f.remove("firstName"),f.remove("lastName"),Z("/")},be=()=>{fe(),B(!1)},x=a=>r=>{r.target.id==="phoneNumber"?Pe(r):a(r.target.value),r.target.id==="currentPassword"?P(!1):P(!0)},ee=a=>{const i=a.replace(/\D/g,"").slice(0,11);let h=i;return i.length>0&&(h="+7 (",i.length>1&&(h+=`${i.slice(1,4)}`),i.length>4&&(h+=`) ${i.slice(4,7)}`),i.length>7&&(h+=`-${i.slice(7,9)}`),i.length>9&&(h+=`-${i.slice(9)}`)),h},Pe=a=>{const r=a.target.value,i=d;if(r.length<i.length){C(r);return}const h=ee(r);C(h)},I=()=>{const a=V(d);return a.length===10?"7"+a:a},xe=async()=>{try{z(!1);const a=I(),r=await j.post("https://api.dom-ban-na-drovah.ru/api/request-phone-change",{userId:w,new_phone_number:a},{headers:{Authorization:`Bearer ${g}`}});r.status===200?(z(!0),D("Код для изменения номера отправлен")):o(r.data.error||"Ошибка при отправке кода")}catch(a){o("Ошибка при отправке кода верификации"),console.error("Ошибка при отправке кода верификации:",a)}},ge=async()=>{try{const a=I(),r=await j.post("https://api.dom-ban-na-drovah.ru/api/verify-phone-change",{userId:w,new_phone_number:a,verification_code:K},{headers:{Authorization:`Bearer ${g}`}});D(r.data.message),O({phone_number:a}),z(!1)}catch(a){o("Ошибка при подтверждении номера"),console.error("Ошибка при подтверждении номера:",a)}},ve=()=>{let a=!1;return c&&!S&&(o("Пожалуйста, введите текущий пароль."),u(r=>({...r,currentPassword:!0})),a=!0),c&&c!==b&&(o("Пароли не совпадают."),u(r=>({...r,confirmPassword:!0})),a=!0),y&&!N&&(o("Номер телефона некорректен."),u(r=>({...r,phone:!0})),a=!0),!a},je=async a=>{var i,h,ae,se,re,te,ne,oe;a.preventDefault(),W(!0),u({firstName:!1,lastName:!1,phone:!1,currentPassword:!1,newPassword:!1,confirmPassword:!1});const r=/^[А-Яа-яЁё]+$/;if(!r.test(m)){u(n=>({...n,firstName:!0})),o("Имя должно содержать только русские буквы."),setTimeout(()=>u(n=>({...n,firstName:!1})),7e3);return}if(!r.test(p)){u(n=>({...n,lastName:!0})),o("Фамилия должна содержать только русские буквы."),setTimeout(()=>u(n=>({...n,lastName:!1})),7e3);return}if(y&&!N){u(n=>({...n,phone:!0})),o("Введите корректный номер телефона."),setTimeout(()=>u(n=>({...n,phone:!1})),7e3);return}if(y&&N){T?await ge():await xe();return}if(ve())try{const n=I(),_=await j.post(`https://api.dom-ban-na-drovah.ru/api/userAccount/${w}/editProfile`,{userId:w,first_name:m,last_name:p,phone_number:n,current_password:S,new_password:c},{headers:{Authorization:`Bearer ${g}`}});_.status===200?(D(_.data.message),O({first_name:m,last_name:p,phone_number:n}),Q(!0),P(!1)):o(_.data.error||"Ошибка регистрации.")}catch(n){if(((i=n.response)==null?void 0:i.status)===400){const _=((ae=(h=n.response)==null?void 0:h.data)==null?void 0:ae.error)||"Некорректные данные. Проверьте форму.";o(_);const v=(re=(se=n.response)==null?void 0:se.data)==null?void 0:re.error;u(Se=>({...Se,phone:v.includes("телефон")||v.includes("корректно"),currentPassword:v.includes("пароль")&&v.includes("текущий"),newPassword:v.includes("пароль")&&v.includes("новый")})),setTimeout(()=>u({firstName:!1,lastName:!1,phone:!1,currentPassword:!1,newPassword:!1,confirmPassword:!1}),8e3)}else((te=n.response)==null?void 0:te.status)===500?o("Произошла ошибка на сервере. Попробуйте позже."):o(((oe=(ne=n.response)==null?void 0:ne.data)==null?void 0:oe.message)||"Ошибка при обновлении данных.")}finally{W(!1)}};t.useEffect(()=>{P(m!==l.first_name||p!==l.last_name||d!==l.phone_number||c!==""||b!=="")},[m,p,d,c,b,l]);const Ce=async()=>{try{const a=await j.get(`https://api.dom-ban-na-drovah.ru/api/userAccount/${w}/profileData`,{headers:{Authorization:`Bearer ${g}`}});G(a.data),X(a.data.first_name),k(a.data.last_name),C(a.data.phone_number),H(""),J(""),P(!1),q(!1),Q(!1)}catch(a){o("Ошибка загрузки данных пользователя."),console.error(a)}},N=()=>{const a=I();return a.length===11&&/^[0-9]+$/.test(a)},ye=c===b,_e=!L||!N()||c&&!ye||m===l.first_name&&p===l.last_name&&d===l.phone_number||s.phone;t.useEffect(()=>{q(d!==l.phone_number&&d.trim()!==""),P(d!==l.phone_number&&d.trim()!==""&&N)},[d,l.phone_number,N]);const $e=()=>y&&N?T?"Подтвердить":"Отправить код":"Сохранить";return e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"auth-block edit",role:"main","aria-labelledby":"profile-heading",children:e.jsxs("div",{className:"auth-content",children:[e.jsx("h1",{className:"auth-title",id:"profile-heading",children:"ЛИЧНЫЙ ПРОФИЛЬ"}),(Y||M)&&e.jsx("div",{className:`auth-message ${M?"error":"success"} ${pe?"fade-in":"fade-out"}`,role:"alert","aria-live":"assertive",children:Y||M}),y&&N&&e.jsx("p",{className:"auth-info","aria-live":"polite",children:"Вам поступит звонок. Для смены телефона введите последние 4 цифры звонившего номера."}),c&&!S&&e.jsx("p",{className:"auth-info","aria-live":"polite",children:"Перед тем как установить новый пароль, пожалуйста, введите текущий пароль."}),e.jsxs("form",{className:"auth-form",onSubmit:je,children:[e.jsxs("div",{className:"auth-row",children:[e.jsxs("div",{className:"auth-column",children:[e.jsxs("label",{className:`auth-label ${s.firstName?"error-label":""}`,htmlFor:"firstName",children:["Имя",e.jsx("input",{type:"text",id:"firstName",className:`auth-input ${s.firstName?"error-input":""}`,placeholder:"Введите имя",onChange:x(X),value:m,maxLength:20,"aria-required":"true","aria-invalid":!!s.firstName,"aria-describedby":s.firstName?"firstName-error":void 0}),s.firstName&&e.jsx("span",{id:"firstName-error",className:"visually-hidden",children:s.firstName})]}),e.jsxs("label",{className:`auth-label ${s.lastName?"error-label":""}`,htmlFor:"lastName",children:["Фамилия",e.jsx("input",{type:"text",id:"lastName",className:`auth-input ${s.lastName?"error-input":""}`,placeholder:"Введите фамилию",onChange:x(k),value:p,maxLength:20,"aria-required":"true","aria-invalid":!!s.lastName,"aria-describedby":s.lastName?"lastName-error":void 0}),s.lastName&&e.jsx("span",{id:"lastName-error",className:"visually-hidden",children:s.lastName})]})]}),e.jsxs("div",{className:"auth-column",children:[e.jsxs("label",{className:`auth-label ${s.phone?"error-label":""}`,htmlFor:"phoneNumber",children:["Номер телефона",e.jsx("input",{type:"tel",id:"phoneNumber",className:`auth-input ${s.phone?"error-input":""}`,placeholder:"+7 (XXX) XXX-XX-XX",onChange:x(C),value:d,maxLength:18,"aria-required":"true","aria-invalid":!!s.phone,"aria-describedby":s.phone?"phone-error":void 0,autoComplete:"off"}),s.phone&&e.jsx("span",{id:"phone-error",className:"visually-hidden",children:s.phone})]}),T&&e.jsxs("label",{className:"auth-label",htmlFor:"verificationCode",children:["Код верификации",e.jsx("input",{type:"text",id:"verificationCode",className:"auth-input",onChange:x(he),value:K,maxLength:4,"aria-required":"true","aria-label":"Введите 4-значный код верификации"})]})]}),e.jsxs("div",{className:"auth-column",children:[e.jsxs("label",{className:`auth-label ${s.currentPassword?"error-label":""}`,htmlFor:"currentPassword",children:["Текущий пароль",e.jsxs("div",{className:"passwordInput",children:[e.jsx("input",{type:F?"text":"password",id:"currentPassword",className:`auth-input ${s.currentPassword?"error-input":""}`,value:S,onChange:x(ie),autoComplete:"current-password",maxLength:16,"aria-required":!!c,"aria-invalid":!!s.currentPassword,"aria-describedby":s.currentPassword?"currentPassword-error":void 0}),e.jsx("button",{type:"button",className:"passwordToggle",onClick:()=>le(!F),"aria-label":F?"Скрыть пароль":"Показать пароль","aria-controls":"currentPassword",children:e.jsx($,{icon:F?R:U,className:"passwordIcon"})})]}),s.currentPassword&&e.jsx("span",{id:"currentPassword-error",className:"visually-hidden",children:s.currentPassword})]}),e.jsxs("label",{className:`auth-label ${s.newPassword?"error-label":""}`,htmlFor:"newPassword",children:["Новый пароль",e.jsxs("div",{className:"passwordInput",children:[e.jsx("input",{type:A?"text":"password",id:"newPassword",className:`auth-input ${s.newPassword?"error-input":""}`,value:c,onChange:x(H),autoComplete:"new-password",maxLength:16,"aria-required":"true","aria-invalid":!!s.newPassword,"aria-describedby":s.newPassword?"newPassword-error":void 0}),e.jsx("button",{type:"button",className:"passwordToggle",onClick:()=>ce(!A),"aria-label":A?"Скрыть пароль":"Показать пароль","aria-controls":"newPassword",children:e.jsx($,{icon:A?R:U,className:"passwordIcon"})})]}),s.newPassword&&e.jsx("span",{id:"newPassword-error",className:"visually-hidden",children:s.newPassword})]}),c&&e.jsxs("label",{className:`auth-label ${s.confirmPassword?"error-label":""}`,htmlFor:"confirmPassword",children:["Подтверждение пароля",e.jsxs("div",{className:"passwordInput",children:[e.jsx("input",{type:E?"text":"password",id:"confirmPassword",className:`auth-input ${s.confirmPassword?"error-input":""}`,value:b,onChange:x(J),autoComplete:"new-password",maxLength:16,"aria-required":"true","aria-invalid":!!s.confirmPassword,"aria-describedby":s.confirmPassword?"confirmPassword-error":void 0}),e.jsx("button",{type:"button",className:"passwordToggle",onClick:()=>de(!E),"aria-label":E?"Скрыть пароль":"Показать пароль","aria-controls":"confirmPassword",children:e.jsx($,{icon:E?R:U,className:"passwordIcon"})})]}),s.confirmPassword&&e.jsx("span",{id:"confirmPassword-error",className:"visually-hidden",children:s.confirmPassword})]})]})]}),e.jsxs("div",{className:"buttonGroup",children:[e.jsx("button",{className:"auth-button",type:"submit",disabled:_e,"aria-busy":me,children:$e()}),L&&e.jsx("button",{type:"button",className:"auth-cancel",onClick:Ce,"aria-label":"Отменить изменения",children:"Отменить изменения"})]})]})]})}),ue&&e.jsxs("div",{className:"modal-delete",role:"dialog","aria-modal":"true","aria-labelledby":"modal-heading",children:[e.jsx("h3",{id:"modal-heading",children:"Вы уверены, что хотите удалить свой аккаунт?"}),e.jsxs("div",{className:"modal-buttons",children:[e.jsx("button",{className:"auth-button",onClick:be,children:"Удалить"}),e.jsx("button",{className:"auth-button",onClick:we,autoFocus:!0,children:"Отмена"})]})]}),e.jsxs("div",{className:"account-action-buttons",children:[e.jsx("button",{className:"logout-button",onClick:Ne,children:e.jsxs("span",{children:[e.jsx($,{icon:Ae,className:"icon","aria-hidden":"true"}),e.jsx("span",{children:"Выйти из аккаунта"})]})}),e.jsx("button",{className:"delete-button",onClick:()=>B(!0),"aria-haspopup":"dialog",children:e.jsxs("span",{children:[e.jsx($,{icon:Ee,className:"icon","aria-hidden":"true"}),e.jsx("span",{children:"Удалить аккаунт"})]})})]})]})};export{Le as default};
