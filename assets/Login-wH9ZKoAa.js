import{r as u,u as L,a as h,l as E,j as s,L as y}from"./index-83Tp2EN1.js";import{a as F}from"./index-t--hEgTQ.js";import{F as T,f as _,a as q}from"./index-BWBgj6Hi.js";import{u as M}from"./auth-Be68LJyF.js";function z(){const[p,g]=u.useState(""),[i,I]=u.useState(""),[n,x]=u.useState(!1),[l,c]=u.useState({phone:!1,password:!1}),{message:w,showMessage:X,error:m,showError:d,isVisible:P}=M(),f=L(),C=e=>{const a=e.replace(/\D/g,"").slice(0,11);let o=a;return a.length>0&&(o="+7 (",a.length>1&&(o+=`${a.slice(1,4)}`),a.length>4&&(o+=`) ${a.slice(4,7)}`),a.length>7&&(o+=`-${a.slice(7,9)}`),a.length>9&&(o+=`-${a.slice(9)}`)),o},A=e=>{const r=e.target.value,a=p;if(r.length<a.length){g(r);return}const o=C(r);g(o)},b=()=>{const e=p.replace(/\D/g,"");return e.length===10?"7"+e:e},D=async()=>{var r,a,o,j,k,S,v;d(""),c({phone:!1,password:!1});const e=b();if(!e||e.length<11||!i){d("Пожалуйста, введите корректный номер телефона и пароль."),c({phone:!e||e.length<11,password:!i});return}try{const t=await F.post("http://api.dom-ban-na-drovah.ru/api/login",{phone_number:e,password:i});if(t.status===200){h.set("token",t.data.token,{expires:7,secure:!0,sameSite:"Strict"}),h.set("userId",t.data.userId,{expires:7,secure:!0,sameSite:"Strict"}),h.set("firstName",t.data.first_name,{expires:7,secure:!0,sameSite:"Strict"}),h.set("lastName",t.data.last_name,{expires:7,secure:!0,sameSite:"Strict"}),X("Вход выполнен успешно!");const $=E(t.data.token);if(!$){console.error("Ошибка: токен не может быть декодирован");return}f($.role==="admin"?`/adminAccount/${t.data.userId}`:`/userAccount/${t.data.userId}`)}}catch(t){((r=t.response)==null?void 0:r.status)===401?((o=(a=t.response)==null?void 0:a.data)!=null&&o.message.includes("Пользователя с таким номером телефона не существует!")?(d("Пользователя с таким номером телефона не существует!"),c({phone:!0,password:!1})):(k=(j=t.response)==null?void 0:j.data)!=null&&k.message.includes("Неверный пароль")&&(d("Неверный пароль! Попробуйте снова."),c({phone:!1,password:!0})),setTimeout(()=>c({phone:!1,password:!1}),8e3)):d(((v=(S=t.response)==null?void 0:S.data)==null?void 0:v.message)||"Ошибка входа.")}};u.useEffect(()=>{const e=h.get("token");if(e){const r=E(e);r.exp*1e3>Date.now()&&f(r.role==="admin"?`/adminAccount/${r.userId}`:`/userAccount/${r.userId}`)}},[f]);const N=!(b().length>=11)||!i;return s.jsx("div",{className:"auth-container",children:s.jsx("div",{className:"auth-block log",children:s.jsxs("div",{className:"auth-content",children:[s.jsx("h2",{className:"auth-title",children:"ВХОД"}),(w||m)&&s.jsx("p",{className:`auth-message ${m?"error":"success"} ${P?"fade-in":"fade-out"}`,role:"alert",children:w||m}),s.jsxs("div",{className:"auth-form",children:[s.jsxs("label",{className:`auth-label ${l.phone?"error-label":""}`,htmlFor:"phone",children:["Номер телефона",s.jsx("input",{type:"tel",id:"phone",className:`auth-input ${l.phone?"error-input":""}`,placeholder:"+7 (XXX) XXX-XX-XX",onChange:A,value:p,"aria-describedby":"phoneError",required:!0,maxLength:18}),l.phone&&s.jsx("span",{id:"phoneError",className:"error-message",children:"Неверный номер телефона"})]}),s.jsxs("label",{className:`auth-label ${l.password?"error-label":""}`,htmlFor:"password",children:["Пароль",s.jsxs("div",{className:"passwordInput",children:[s.jsx("input",{type:n?"text":"password",id:"password",className:`auth-input ${l.password?"error-input":""}`,placeholder:"Введите пароль",onChange:e=>I(e.target.value),value:i,maxLength:16,"aria-describedby":"passwordError",required:!0}),s.jsx(T,{icon:n?_:q,className:"passwordIcon",onClick:()=>x(!n),"aria-label":n?"Скрыть пароль":"Показать пароль",tabIndex:"0",onKeyDown:e=>{(e.key==="Enter"||e.key===" ")&&x(!n)},role:"button","aria-pressed":n})]}),l.password&&s.jsx("span",{id:"passwordError",className:"error-message",children:"Неверный пароль"})]}),s.jsx("button",{className:"auth-button",onClick:D,disabled:N,"aria-disabled":N,children:"Войти"})]}),s.jsxs("div",{className:"auth-links",children:[s.jsxs("p",{children:["Еще нет учетной записи? ",s.jsx(y,{to:"/register",className:"auth-link",children:"Зарегистрируйтесь"})]}),s.jsx(y,{to:"/forgot-password",className:"auth-link",children:"Забыли пароль?"})]})]})})})}export{z as default};
