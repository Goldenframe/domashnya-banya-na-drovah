import{r as n,u as Fe,j as e,a as u}from"./index-BrGn0uWy.js";import{a as x}from"./index-t--hEgTQ.js";import{F as $,a as R,b as U,h as Ae,i as De}from"./index-B8y_8w5a.js";import{u as Ee}from"./auth-CcCT8WCt.js";const Le=({userId:h,token:p,updateUserData:O})=>{const[f,X]=n.useState(""),[w,k]=n.useState(""),[g,v]=n.useState(""),[N,G]=n.useState(!1),[S,H]=n.useState({}),[_,ie]=n.useState(""),[l,J]=n.useState(""),[j,K]=n.useState(""),[F,le]=n.useState(!1),[A,ce]=n.useState(!1),[D,de]=n.useState(!1),[ue,q]=n.useState(!1),[B,C]=n.useState(!1),[L,T]=n.useState(!1),[Q,he]=n.useState(""),[s,c]=n.useState({firstName:!1,lastName:!1,phone:!1,currentPassword:!1,newPassword:!1,confirmPassword:!1}),[Ie,W]=n.useState(!1),[me,Y]=n.useState(!1),{message:Z,showMessage:E,error:z,showError:o,isVisible:pe}=Ee(),ee=Fe();n.useEffect(()=>{(async()=>{try{const r=await x.get(`https://api.dom-ban-na-drovah.ru/api/userAccount/${h}/profileData`,{headers:{Authorization:`Bearer ${p}`}});H(r.data),X(r.data.first_name),k(r.data.last_name),v(V(r.data.phone_number))}catch(r){o("Ошибка загрузки данных пользователя"),console.error("Ошибка загрузки данных пользователя:",r)}})()},[h,p]);const M=a=>a.replace(/\D/g,"");n.useEffect(()=>{const a=M(g),r=M(S.phone_number||"");C(f!==S.first_name||w!==S.last_name||a!==r||l!==""||j!==""),G(a!==r&&a.trim()!=="")},[f,w,g,l,j,S]);const fe=async()=>{try{const a=u.get("token");if(!a){o("Не найден токен. Пожалуйста, войдите снова.");return}const r=await x.delete(`https://api.dom-ban-na-drovah.ru/api/userAccount/${h}`,{headers:{Authorization:`Bearer ${a}`}});E(r.data.message),u.remove("token"),u.remove("userId"),u.remove("firstName"),u.remove("lastName"),ee("/login")}catch(a){o("Ошибка при удалении аккаунта"),console.error("Ошибка при удалении аккаунта:",a)}},we=()=>{q(!1)},Ne=()=>{u.remove("token"),u.remove("userId"),u.remove("firstName"),u.remove("lastName"),ee("/")},be=()=>{fe(),q(!1)},m=a=>r=>{r.target.id==="phoneNumber"?Pe(r):a(r.target.value),r.target.id==="currentPassword"?C(!1):C(!0)},V=a=>{const i=a.replace(/\D/g,"").slice(0,11);let d=i;return i.length>0&&(d="+7 (",i.length>1&&(d+=`${i.slice(1,4)}`),i.length>4&&(d+=`) ${i.slice(4,7)}`),i.length>7&&(d+=`-${i.slice(7,9)}`),i.length>9&&(d+=`-${i.slice(9)}`)),d},Pe=a=>{const r=a.target.value,i=g;if(r.length<i.length){v(r);return}const d=V(r);v(d)},I=()=>{const a=M(g);return a.length===10?"7"+a:a},xe=async()=>{try{T(!1);const a=I(),r=await x.post("https://api.dom-ban-na-drovah.ru/api/request-phone-change",{userId:h,new_phone_number:a},{headers:{Authorization:`Bearer ${p}`}});r.status===200?(T(!0),E("Код для изменения номера отправлен")):o(r.data.error||"Ошибка при отправке кода")}catch(a){o("Ошибка при отправке кода верификации"),console.error("Ошибка при отправке кода верификации:",a)}},ge=async()=>{try{const a=I(),r=await x.post("https://api.dom-ban-na-drovah.ru/api/verify-phone-change",{userId:h,new_phone_number:a,verification_code:Q},{headers:{Authorization:`Bearer ${p}`}});E(r.data.message),O({phone_number:a}),T(!1)}catch(a){o("Ошибка при подтверждении номера"),console.error("Ошибка при подтверждении номера:",a)}},ve=()=>{let a=!1;return l&&!_&&(o("Пожалуйста, введите текущий пароль."),c(r=>({...r,currentPassword:!0})),a=!0),l&&l!==j&&(o("Пароли не совпадают."),c(r=>({...r,confirmPassword:!0})),a=!0),N&&!b()&&(o("Номер телефона некорректен."),c(r=>({...r,phone:!0})),a=!0),!a},je=async a=>{var i,d,ae,se,re,te,ne,oe;a.preventDefault(),Y(!0),c({firstName:!1,lastName:!1,phone:!1,currentPassword:!1,newPassword:!1,confirmPassword:!1});const r=/^[А-Яа-яЁё]+$/;if(!r.test(f)){c(t=>({...t,firstName:!0})),o("Имя должно содержать только русские буквы."),setTimeout(()=>c(t=>({...t,firstName:!1})),7e3);return}if(!r.test(w)){c(t=>({...t,lastName:!0})),o("Фамилия должна содержать только русские буквы."),setTimeout(()=>c(t=>({...t,lastName:!1})),7e3);return}if(N&&!b()){c(t=>({...t,phone:!0})),o("Введите корректный номер телефона."),setTimeout(()=>c(t=>({...t,phone:!1})),7e3);return}if(N&&b()){L?await ge():await xe();return}if(ve())try{const t=I(),y=await x.post(`https://api.dom-ban-na-drovah.ru/api/userAccount/${h}/editProfile`,{userId:h,first_name:f,last_name:w,phone_number:t,current_password:_,new_password:l},{headers:{Authorization:`Bearer ${p}`}});y.status===200?(E(y.data.message),O({first_name:f,last_name:w,phone_number:t}),W(!0),C(!1)):o(y.data.error||"Ошибка регистрации.")}catch(t){if(((i=t.response)==null?void 0:i.status)===400){const y=((ae=(d=t.response)==null?void 0:d.data)==null?void 0:ae.error)||"Некорректные данные. Проверьте форму.";o(y);const P=(re=(se=t.response)==null?void 0:se.data)==null?void 0:re.error;c(_e=>({..._e,phone:P.includes("телефон")||P.includes("корректно"),currentPassword:P.includes("пароль")&&P.includes("текущий"),newPassword:P.includes("пароль")&&P.includes("новый")})),setTimeout(()=>c({firstName:!1,lastName:!1,phone:!1,currentPassword:!1,newPassword:!1,confirmPassword:!1}),8e3)}else((te=t.response)==null?void 0:te.status)===500?o("Произошла ошибка на сервере. Попробуйте позже."):o(((oe=(ne=t.response)==null?void 0:ne.data)==null?void 0:oe.message)||"Ошибка при обновлении данных.")}finally{Y(!1)}},Ce=async()=>{try{const a=await x.get(`https://api.dom-ban-na-drovah.ru/api/userAccount/${h}/profileData`,{headers:{Authorization:`Bearer ${p}`}});H(a.data),X(a.data.first_name),k(a.data.last_name),v(V(a.data.phone_number)),J(""),K(""),C(!1),G(!1),W(!1)}catch(a){o("Ошибка загрузки данных пользователя."),console.error(a)}},b=()=>{const a=I();return a.length===11&&/^[0-9]+$/.test(a)},ye=l===j,$e=!B||N&&!b()||l&&!ye||s.phone,Se=()=>N&&b()?L?"Подтвердить":"Отправить код":"Сохранить";return e.jsxs(e.Fragment,{children:[e.jsx("main",{className:"auth-block edit",role:"main","aria-labelledby":"profile-heading",children:e.jsxs("div",{className:"auth-content",children:[e.jsx("h1",{className:"auth-title",id:"profile-heading",children:"ЛИЧНЫЙ ПРОФИЛЬ"}),(Z||z)&&e.jsx("div",{className:`auth-message ${z?"error":"success"} ${pe?"fade-in":"fade-out"}`,role:"alert","aria-live":"assertive",children:Z||z}),N&&b()&&e.jsx("p",{className:"auth-info","aria-live":"polite",children:"Вам поступит звонок. Для смены телефона введите последние 4 цифры звонившего номера."}),l&&!_&&e.jsx("p",{className:"auth-info","aria-live":"polite",children:"Перед тем как установить новый пароль, пожалуйста, введите текущий пароль."}),e.jsxs("form",{className:"auth-form",onSubmit:je,autoComplete:"off",children:[e.jsxs("div",{className:"auth-row",children:[e.jsxs("div",{className:"auth-column",children:[e.jsxs("label",{className:`auth-label ${s.firstName?"error-label":""}`,htmlFor:"firstName",children:["Имя",e.jsx("input",{type:"text",id:"firstName",className:`auth-input ${s.firstName?"error-input":""}`,placeholder:"Введите имя",onChange:m(X),value:f,maxLength:20,"aria-required":"true","aria-invalid":!!s.firstName,"aria-describedby":s.firstName?"firstName-error":void 0}),s.firstName&&e.jsx("span",{id:"firstName-error",className:"visually-hidden",children:s.firstName})]}),e.jsxs("label",{className:`auth-label ${s.lastName?"error-label":""}`,htmlFor:"lastName",children:["Фамилия",e.jsx("input",{type:"text",id:"lastName",className:`auth-input ${s.lastName?"error-input":""}`,placeholder:"Введите фамилию",onChange:m(k),value:w,maxLength:20,"aria-required":"true","aria-invalid":!!s.lastName,"aria-describedby":s.lastName?"lastName-error":void 0}),s.lastName&&e.jsx("span",{id:"lastName-error",className:"visually-hidden",children:s.lastName})]})]}),e.jsxs("div",{className:"auth-column",children:[e.jsxs("label",{className:`auth-label ${s.phone?"error-label":""}`,htmlFor:"phoneNumber",children:["Номер телефона",e.jsx("input",{type:"tel",id:"phoneNumber",className:`auth-input ${s.phone?"error-input":""}`,placeholder:"+7 (XXX) XXX-XX-XX",onChange:m(v),value:g,maxLength:18,"aria-required":"true","aria-invalid":!!s.phone,"aria-describedby":s.phone?"phone-error":void 0,autoComplete:"off"}),s.phone&&e.jsx("span",{id:"phone-error",className:"visually-hidden",children:s.phone})]}),L&&e.jsxs("label",{className:"auth-label",htmlFor:"verificationCode",children:["Код верификации",e.jsx("input",{type:"text",id:"verificationCode",className:"auth-input",onChange:m(he),value:Q,maxLength:4,"aria-required":"true","aria-label":"Введите 4-значный код верификации"})]})]}),e.jsxs("div",{className:"auth-column",children:[e.jsxs("label",{className:`auth-label ${s.currentPassword?"error-label":""}`,htmlFor:"currentPassword",children:["Текущий пароль",e.jsxs("div",{className:"passwordInput",children:[e.jsx("input",{type:F?"text":"password",id:"currentPassword",className:`auth-input ${s.currentPassword?"error-input":""}`,value:_,onChange:m(ie),autoComplete:"current-password",maxLength:16,"aria-required":!!l,"aria-invalid":!!s.currentPassword,"aria-describedby":s.currentPassword?"currentPassword-error":void 0}),e.jsx("button",{type:"button",className:"passwordToggle",onClick:()=>le(!F),"aria-label":F?"Скрыть пароль":"Показать пароль","aria-controls":"currentPassword",children:e.jsx($,{icon:F?R:U,className:"passwordIcon"})})]}),s.currentPassword&&e.jsx("span",{id:"currentPassword-error",className:"visually-hidden",children:s.currentPassword})]}),e.jsxs("label",{className:`auth-label ${s.newPassword?"error-label":""}`,htmlFor:"newPassword",children:["Новый пароль",e.jsxs("div",{className:"passwordInput",children:[e.jsx("input",{type:A?"text":"password",id:"newPassword",className:`auth-input ${s.newPassword?"error-input":""}`,value:l,onChange:m(J),autoComplete:"new-password",maxLength:16,"aria-required":"true","aria-invalid":!!s.newPassword,"aria-describedby":s.newPassword?"newPassword-error":void 0}),e.jsx("button",{type:"button",className:"passwordToggle",onClick:()=>ce(!A),"aria-label":A?"Скрыть пароль":"Показать пароль","aria-controls":"newPassword",children:e.jsx($,{icon:A?R:U,className:"passwordIcon"})})]}),s.newPassword&&e.jsx("span",{id:"newPassword-error",className:"visually-hidden",children:s.newPassword})]}),l&&e.jsxs("label",{className:`auth-label ${s.confirmPassword?"error-label":""}`,htmlFor:"confirmPassword",children:["Подтверждение пароля",e.jsxs("div",{className:"passwordInput",children:[e.jsx("input",{type:D?"text":"password",id:"confirmPassword",className:`auth-input ${s.confirmPassword?"error-input":""}`,value:j,onChange:m(K),autoComplete:"new-password",maxLength:16,"aria-required":"true","aria-invalid":!!s.confirmPassword,"aria-describedby":s.confirmPassword?"confirmPassword-error":void 0}),e.jsx("button",{type:"button",className:"passwordToggle",onClick:()=>de(!D),"aria-label":D?"Скрыть пароль":"Показать пароль","aria-controls":"confirmPassword",children:e.jsx($,{icon:D?R:U,className:"passwordIcon"})})]}),s.confirmPassword&&e.jsx("span",{id:"confirmPassword-error",className:"visually-hidden",children:s.confirmPassword})]})]})]}),e.jsxs("div",{className:"buttonGroup",children:[e.jsx("button",{className:"auth-button",type:"submit",disabled:$e,"aria-busy":me,children:Se()}),B&&e.jsx("button",{type:"button",className:"auth-cancel",onClick:Ce,"aria-label":"Отменить изменения",children:"Отменить изменения"})]})]})]})}),ue&&e.jsxs("div",{className:"modal-delete",role:"dialog","aria-modal":"true","aria-labelledby":"modal-heading",children:[e.jsx("h3",{id:"modal-heading",children:"Вы уверены, что хотите удалить свой аккаунт?"}),e.jsxs("div",{className:"modal-buttons",children:[e.jsx("button",{className:"auth-button",onClick:be,children:"Удалить"}),e.jsx("button",{className:"auth-button",onClick:we,autoFocus:!0,children:"Отмена"})]})]}),e.jsxs("div",{className:"account-action-buttons",children:[e.jsx("button",{className:"logout-button",onClick:Ne,children:e.jsxs("span",{children:[e.jsx($,{icon:Ae,className:"icon","aria-hidden":"true"}),e.jsx("span",{children:"Выйти из аккаунта"})]})}),e.jsx("button",{className:"delete-button",onClick:()=>q(!0),"aria-haspopup":"dialog",children:e.jsxs("span",{children:[e.jsx($,{icon:De,className:"icon","aria-hidden":"true"}),e.jsx("span",{children:"Удалить аккаунт"})]})})]})]})};export{Le as default};
