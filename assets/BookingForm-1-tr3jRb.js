import{r as b,j as e,a as ae}from"./index-BrGn0uWy.js";import{a as G}from"./index-t--hEgTQ.js";import{F as ie,e as ue,g as de}from"./index-B8y_8w5a.js";import{S as le}from"./react-select.esm-DfUWdPW9.js";import{u as me}from"./auth-CcCT8WCt.js";function he({availableDates:l,bookingDate:L,setBookingDate:n}){const[C,p]=b.useState(new Date),w=l.map(i=>new Date(i)).sort((i,c)=>i-c),f=i=>{const c=i.getFullYear(),N=String(i.getMonth()+1).padStart(2,"0"),q=String(i.getDate()).padStart(2,"0");return`${c}-${N}-${q}`},j=C.getFullYear(),m=C.getMonth(),g=[],S=new Date(j,m,1),$=Array.from({length:new Date(j,m+1,0).getDate()},(i,c)=>new Date(j,m,c+1)),F=$.filter(i=>!w.some(c=>f(c)===f(i))),k=(S.getDay()+6)%7;for(let i=0;i<k;i++)g.push(e.jsx("div",{"aria-hidden":"true",role:"presentation",tabIndex:"-1"},`empty-${i}`));$.forEach(i=>{const c=f(i),N=F.some(I=>f(I)===c);let q="calendar_day";N&&(q+=" no-interval"),L.includes(c)&&(q+=" selected"),g.push(e.jsx("div",{className:q,onClick:N?void 0:()=>n(I=>I===c?"":c),role:"gridcell","aria-label":`${i.toLocaleString("ru-RU",{weekday:"long"})}, ${i.getDate()} ${i.toLocaleString("ru-RU",{month:"long"})} ${i.getFullYear()}`,tabIndex:N?"-1":"0",children:i.getDate()},`day-${c}`))});const M=(7-new Date(j,m+1,0).getDay())%7;for(let i=0;i<M;i++)g.push(e.jsx("div",{"aria-hidden":"true",role:"presentation",tabIndex:"-1"},`empty-after-${i}`));const W=["Январь","Февраль","Март","Апрель","Май","Июнь","Июль","Август","Сентябрь","Октябрь","Ноябрь","Декабрь"];return e.jsx("div",{role:"application",children:e.jsxs("div",{className:"calendar_container",children:[e.jsxs("div",{className:"calendar_header",children:[e.jsx("button",{onClick:()=>p(new Date(j,m-1,1)),type:"button",className:"arrow-button","aria-label":"Предыдущий месяц",children:e.jsx(ie,{icon:ue})}),e.jsx("span",{children:`${W[m]} ${j}`}),e.jsx("button",{onClick:()=>p(new Date(j,m+1,1)),type:"button",className:"arrow-button","aria-label":"Следующий месяц",children:e.jsx(ie,{icon:de})})]}),e.jsxs("div",{className:"calendar",role:"grid",children:[["Пн","Вт","Ср","Чт","Пт","Сб","Вс"].map((i,c)=>e.jsx("div",{style:{textAlign:"center",fontWeight:"bold"},role:"columnheader",children:i},c)),g]})]})})}function pe({additionalServices:l,setAdditionalServices:L,discounts:n,start:C,end:p,bookingDate:w,additionalServicesQuantity:f,setAdditionalServicesQuantity:j}){var Q,M,W,i,c,N,q,I,R,J,U,P,H,z,K,B;const m={broom:450,towel:200,hat:50,sheets:200},g={broom:4,towel:8,hat:8,sheets:2},S=()=>{const r={...f};n.forEach(d=>{if(d.discount_type!=="free"||!F(d))return;(d.applicable_services.length>0?d.applicable_services:Object.keys(d.free_service_counts)).forEach(y=>{var X,Y;const D=((X=l[y])==null?void 0:X.quantity)||0,V=parseInt(((Y=d.min_service_counts)==null?void 0:Y[y])||"0",10);if(D>=V){const Z=Math.floor(D/V)*d.free_service_counts[y];r[y]=(r[y]||0)+Z}})}),j(r)};b.useEffect(()=>{S()},[w,l]);const $=(r,d)=>{d=Math.max(0,Math.min(d,g[r])),L(y=>({...y,[r]:{selected:d>0,quantity:d}}));const T=A();j(y=>({...y,[r]:T}))},F=r=>{if(!C||!p||!w)return!1;const d=new Date(`${w}T${C}`),T=new Date(`${w}T${p}`),y=new Date(`${w}T${r.valid_from}`),D=new Date(`${w}T${r.valid_till}`);return r.time_discount_type==="time_limit"?d>=y&&T<=D&&r.applicable_days.includes(w):d>=y&&T<=D},A=(r,d,T)=>0,k=r=>{var T;const d=n==null?void 0:n.find(y=>{var D;return((D=y.applicable_services)==null?void 0:D.includes(r))&&y.discount_type==="discount_service"&&F(y)});return((T=d==null?void 0:d.service_prices)==null?void 0:T[r])??m[r]},_=(r,d)=>{var y;const T=((y=l[r])==null?void 0:y.quantity)||0;$(r,T+d)};return e.jsxs("section",{className:"additional-services","aria-labelledby":"additional-services-heading",children:[e.jsxs("div",{className:"service-item",children:[e.jsx("div",{className:"service-info",children:e.jsxs("label",{htmlFor:"broom-quantity",children:["Дубовые веники (+",k("broom")," ₽)",f.broom>0&&e.jsxs("span",{className:"free-gift",children:[" ","(+",f.broom," в подарок)"]})]})}),e.jsxs("div",{className:"service-quantity",children:[e.jsx("button",{onClick:()=>_("broom",-1),type:"button","aria-label":"Уменьшить количество дубовых веников",disabled:((Q=l.broom)==null?void 0:Q.quantity)===0,children:"-"}),e.jsx("input",{id:"broom-quantity",type:"number",min:"0",max:g.broom,value:((M=l.broom)==null?void 0:M.quantity)||0,onChange:r=>$("broom",parseInt(r.target.value)),className:"service-quantity-input","aria-label":"Количество дубовых веников"}),e.jsx("button",{onClick:()=>_("broom",1),type:"button","aria-label":"Увеличить количество дубовых веников",disabled:((W=l.broom)==null?void 0:W.quantity)===g.broom,children:"+"})]})]}),e.jsxs("div",{className:"service-item",children:[e.jsx("div",{className:"service-info",children:e.jsxs("label",{htmlFor:"towel-quantity",children:["Полотенце (+",k("towel")," ₽)"]})}),e.jsxs("div",{className:"service-quantity",children:[e.jsx("button",{onClick:()=>_("towel",-1),type:"button","aria-label":"Уменьшить количество полотенец",disabled:((i=l.towel)==null?void 0:i.quantity)===0,children:"-"}),e.jsx("input",{id:"towel-quantity",type:"number",min:"0",max:g.towel,value:((c=l.towel)==null?void 0:c.quantity)||0,onChange:r=>$("towel",parseInt(r.target.value)),className:"service-quantity-input","aria-label":"Количество полотенец"}),e.jsx("button",{onClick:()=>_("towel",1),type:"button","aria-label":"Увеличить количество полотенец",disabled:((N=l.towel)==null?void 0:N.quantity)===g.towel,children:"+"})]})]}),e.jsxs("div",{className:"service-item",children:[e.jsx("div",{className:"service-info",children:e.jsxs("label",{htmlFor:"hat-quantity",children:["Шапка (+",k("hat")," ₽)",A("hat",((q=l.hat)==null?void 0:q.quantity)||0)>0&&e.jsxs("span",{className:"free-gift",children:[" ","(+",A("hat",((I=l.hat)==null?void 0:I.quantity)||0)," ","в подарок)"]})]})}),e.jsxs("div",{className:"service-quantity",children:[e.jsx("button",{onClick:()=>_("hat",-1),type:"button","aria-label":"Уменьшить количество шапок",disabled:((R=l.hat)==null?void 0:R.quantity)===0,children:"-"}),e.jsx("input",{id:"hat-quantity",type:"number",min:"0",max:g.hat,value:((J=l.hat)==null?void 0:J.quantity)||0,onChange:r=>$("hat",parseInt(r.target.value)),className:"service-quantity-input","aria-label":"Количество шапок"}),e.jsx("button",{onClick:()=>_("hat",1),type:"button","aria-label":"Увеличить количество шапок",disabled:((U=l.hat)==null?void 0:U.quantity)===g.hat,children:"+"})]})]}),e.jsxs("div",{className:"service-item",children:[e.jsx("div",{className:"service-info",children:e.jsxs("label",{htmlFor:"sheets-quantity",children:["Простынь (+",k("sheets")," ₽)",A("sheets",((P=l.sheets)==null?void 0:P.quantity)||0)>0&&e.jsxs("span",{className:"free-gift",children:[" ","(+",A("sheets",((H=l.sheets)==null?void 0:H.quantity)||0)," ","в подарок)"]})]})}),e.jsxs("div",{className:"service-quantity",children:[e.jsx("button",{onClick:()=>_("sheets",-1),type:"button","aria-label":"Уменьшить количество простыней",disabled:((z=l.sheets)==null?void 0:z.quantity)===0,children:"-"}),e.jsx("input",{id:"sheets-quantity",type:"number",min:"0",max:g.sheets,value:((K=l.sheets)==null?void 0:K.quantity)||0,onChange:r=>$("sheets",parseInt(r.target.value)),className:"service-quantity-input","aria-label":"Количество простыней"}),e.jsx("button",{onClick:()=>_("sheets",1),type:"button","aria-label":"Увеличить количество простыней",disabled:((B=l.sheets)==null?void 0:B.quantity)===g.sheets,children:"+"})]})]})]})}function xe({userId:l,token:L}){const[n,C]=b.useState(""),[p,w]=b.useState(""),[f,j]=b.useState(""),[m,g]=b.useState({broom:{selected:!1,quantity:0},towel:{selected:!1,quantity:0},hat:{selected:!1,quantity:0},sheets:{selected:!1,quantity:0}}),[S,$]=b.useState({broom:0,towel:0,hat:0,sheets:0}),[F,A]=b.useState(0),[k,_]=b.useState([]),[Q,M]=b.useState([]),[W,i]=b.useState([]),[c,N]=b.useState([]),[q,I]=b.useState(""),[R,J]=b.useState(""),{message:U,showMessage:P,error:H,showError:z,isVisible:K}=me(),B=new Date;new Date(B).setDate(B.getDate()+21);const d=b.useCallback(async()=>{try{const t=ae.get("token");let s=(await G.get(`https://api.dom-ban-na-drovah.ru/api/userAccount/${l}/availableIntervals/${n}`,{headers:{Authorization:`Bearer ${t}`}})).data.availableStartTimes;_(s),P("")}catch(t){console.error("Ошибка при получении интервалов:",t),z("Произошла ошибка при получении доступных интервалов.")}},[l,n]),T=b.useCallback(async(t,a)=>{try{const s=ae.get("token"),o=await G.get(`https://api.dom-ban-na-drovah.ru/api/userAccount/${l}/availableEndTimes/${n}/${t}/${a}`,{headers:{Authorization:`Bearer ${s}`}});if(o.data.availableEndTimes.length===0)_(v=>v.filter(h=>h.startTime!==t)),P("Нет доступных конечных времен для выбранного времени начала."),M([]);else{const v=o.data.availableEndTimes.map(h=>h.endTime);v.includes("24:00")||v.push("24:00"),M(v),P("")}}catch(s){console.error("Ошибка при получении конечных времен:",s),z("Произошла ошибка при получении доступных конечных времен.")}},[l,n]);b.useEffect(()=>{n&&d()},[n,d]),b.useEffect(()=>{let t=c.filter(a=>a.time_discount_type==="time_limit"&&a.applicable_days.includes(n));I(t.length>0?t:[])},[n,c]),b.useEffect(()=>{let t=c.filter(a=>a.time_discount_type==="no_time_limit");J(t.length>0?t:[])},[n,c]);const y=t=>{const a=t.value;w(a);const s=k.find(o=>o.startTime===a);s?(T(a,s.intervalId),f&&D(a,f)):M([])},D=async(t,a)=>{const s=t?new Date(`${n}T${t}`):null,o=a?new Date(`${n}T${a}`):null,v=s&&o?await X(s,o):0,h=re(s,o);A(v+h)};b.useEffect(()=>{D(p,f)},[m,n]);const V=async()=>{try{const t=await G.get(`https://api.dom-ban-na-drovah.ru/api/userAccount/${l}/discounts`,{headers:{Authorization:`Bearer ${L}`}});N(t.data)}catch(t){return console.error("Ошибка при получении скидок:",t),[]}};b.useEffect(()=>{V()},[l]),b.useEffect(()=>{w(""),j("")},[n]);const X=async(t,a)=>{const s=new Date(t),o=new Date(a);if(o.getHours()===0&&o.getMinutes()===0&&(o.setFullYear(s.getFullYear(),s.getMonth(),s.getDate()),o.setHours(24,0,0,0)),o<=s)return 0;const h=(o.getTime()-s.getTime())/(1e3*60*60);let u=0;const x=s.getHours(),E=s.getDay();return E===0||E===6?u=h<=2?3800:Math.round(1600*h):x>=8&&x<16?u=h<=2?3500:Math.round(1500*h):(x>=16||x<8)&&(u=h<=2?3800:Math.round(1600*h)),c.forEach(ne=>{if(Y(ne,s,o)){const ce=Z(u,ne);u-=ce}}),Math.max(0,Math.round(u))},Y=(t,a,s)=>{const o=new Date(`${n}T${t.valid_from}`),v=new Date(`${n}T${t.valid_till}`),h=a||new Date(`${n}T08:00`),u=s||new Date(`${n}T23:59`);return t.time_discount_type==="time_limit"?h>=o&&u<=v&&t.applicable_days.includes(n):h>=o&&u<=v},Z=(t,a)=>a.discount_type==="discount"?t*(a.discount_percentage/100):0,re=(t,a)=>{var v,h;let s=0;const o={broom:450,towel:200,hat:50,sheets:200};for(let u in m)if(((v=m[u])==null?void 0:v.quantity)>0){const x=c.find(O=>Array.isArray(O.applicable_services)&&O.applicable_services.includes(u)&&O.discount_type==="discount_service"&&Y(O,t,a)),E=((h=x==null?void 0:x.service_prices)==null?void 0:h[u])??o[u];s+=m[u].quantity*E}return s},ee=t=>t?Q.filter(a=>a>t).sort().map(a=>({value:a,label:a})):[],te=k.map(t=>({value:t.startTime,label:t.startTime})),oe=async t=>{t.preventDefault();const a=ae.get("token"),s=p?new Date(`${n}T${p}`):null,o=f?new Date(`${n}T${f}`):null,v=c.filter(u=>Y(u,s,o)?u.discount_type==="discount_service"?u.applicable_services.some(x=>{var E;return((E=m[x])==null?void 0:E.quantity)>0}):!0:!1),h=v.length>0?v[0].id:null;try{if(!n||!p||!f)throw new Error("Пожалуйста, выберите дату и время.");const u=await G.post(`https://api.dom-ban-na-drovah.ru/api/userAccount/${l}/book`,{booking_date:n,start_time:p,end_time:f,price:F,broom:m.broom.selected,broom_quantity:m.broom.quantity+(S.broom||0),towel:m.towel.selected,towel_quantity:m.towel.quantity+(S.towel||0),hat:m.hat.selected,hat_quantity:m.hat.quantity+(S.hat||0),sheets:m.sheets.selected,sheets_quantity:m.sheets.quantity+(S.sheets||0),discount_id:h},{headers:{Authorization:`Bearer ${a}`}});P("Бронь успешно оформлена!"),(await se(l,[n],a)).includes(n)&&i(E=>E.filter(O=>O!==n)),C(""),w(""),j(""),A(0),g({broom:{selected:!1,quantity:0},towel:{selected:!1,quantity:0},hat:{selected:!1,quantity:0},sheets:{selected:!1,quantity:0}}),$({broom:0,towel:0,hat:0,sheets:0})}catch(u){let x=u.message;u.response?x=u.response.data.error||u.response.data.message||"Произошла непредвиденная ошибка.":u.request&&(x="Ошибка сети. Пожалуйста, проверьте Ваше соединение."),z(x),console.error("Ошибка при бронировании:",u)}},se=async(t,a,s)=>{const o=[];for(const v of a)try{(await G.get(`https://api.dom-ban-na-drovah.ru/api/userAccount/${t}/availableIntervals/${v}`,{headers:{Authorization:`Bearer ${s}`}})).data.availableStartTimes.length===0&&o.push(v)}catch(h){console.error(`Ошибка при проверке доступности для даты ${v}:`,h)}return o};return b.useEffect(()=>{const t=[];for(let a=0;a<62;a++){const s=new Date(B);s.setDate(B.getDate()+a),t.push(s.toISOString().slice(0,10))}se(l,t,L).then(a=>{const s=t.filter(o=>!a.includes(o));i(s),s.length>0&&C(s[0])})},[l,L]),e.jsx("section",{className:"account-content",children:e.jsxs("div",{className:"account-form book",children:[(U||H)&&e.jsx("div",{className:`auth-message ${H?"error":"success"} ${K?"fade-in":"fade-out"}`,role:H?"alert":"status","aria-live":"assertive",children:U||H}),e.jsxs("form",{onSubmit:oe,className:"booking-wrapper","aria-labelledby":"bookingFormTitle",children:[e.jsx("div",{className:"calendar-container",children:e.jsx(he,{availableDates:W,setAvailableDates:i,setBookingDate:C,bookingDate:n})}),e.jsxs("div",{className:"time-controls",children:[R.length>0&&e.jsx("section",{"aria-labelledby":"permanentDiscountsHeading",className:"discounts",children:e.jsx("div",{className:"discount permanent-discount",role:"region",children:R.map((t,a)=>e.jsxs("p",{children:[e.jsx("strong",{children:"Постоянная акция:"})," ",t.description]},a))})}),q.length>0&&e.jsx("section",{"aria-labelledby":"temporaryDiscountsHeading",className:"discounts",children:e.jsx("div",{className:"discount temporary-discount",role:"region",children:q.map((t,a)=>e.jsxs("p",{children:[e.jsx("strong",{children:"Временная акция:"})," ",t.description]},a))})}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"startTimeSelect",className:"form-label",children:"Время начала:"}),e.jsx(le,{id:"startTimeSelect",inputId:"startTimeInput",value:p?{value:p,label:p}:null,onChange:y,options:te,classNamePrefix:"time-select",placeholder:"Выберите время",isDisabled:te.length===0,"aria-labelledby":"startTimeLabel","aria-describedby":te.length===0?"noStartTimesHelp":void 0})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"endTimeSelect",className:"form-label",children:"Время окончания:"}),e.jsx(le,{id:"endTimeSelect",inputId:"endTimeInput",value:f?{value:f,label:f}:null,onChange:t=>{j(t.value),D(p,t.value)},options:ee(p),classNamePrefix:"time-select",placeholder:"Выберите время",isDisabled:!p||ee(p).length===0,"aria-labelledby":"endTimeLabel","aria-describedby":p?ee(p).length===0?"noEndTimesHelp":void 0:"selectStartTimeFirstHelp"})]})]}),e.jsx("div",{className:"additional-services-container",children:e.jsx(pe,{additionalServices:m,setAdditionalServices:g,discounts:c,start:p,end:f,bookingDate:n,additionalServicesQuantity:S,setAdditionalServicesQuantity:$})}),e.jsx("div",{className:"price-container",role:"region","aria-live":"polite",children:e.jsxs("div",{className:"price-content",children:[e.jsxs("p",{className:"price",children:["Итоговая стоимость:",e.jsxs("span",{"aria-label":`${F} рублей`,children:[F," ₽"]})]}),e.jsx("button",{type:"submit",className:"form-button",disabled:!n||!p||!f,"aria-disabled":!n||!p||!f,children:"Забронировать"})]})})]})]})})}export{xe as default};
